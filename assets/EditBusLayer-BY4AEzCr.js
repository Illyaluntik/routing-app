const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/deleteForwardEdits-BcYt-bvj.js","assets/index-CzeihLq6.js","assets/index-DNW3oZw8.css","assets/DeleteForwardEditsParameters-hdekXro9.js"])))=>i.map(i=>d[i]);
import{gr as R,_ as w,a4 as U,n as j,u as T,v as k,aG as m,dm as x,Y as D}from"./index-CzeihLq6.js";const P=R(),V=new Map,A=new Map;async function G(e,i,d){if(!e||!d)return!1;if(!i)return!0;const n=new URL(e).host;let r=V.get(n);if(!r){const a=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");r=(await U(a,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return r===i}async function N(e,i,d=!1){if(!e||!i)return!0;const n=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),r=A.get(n)?.entries();if(r){for(const[a,t]of r)if(t.name===i){const c=!t.stack?.hasForwardEdits();if(!c&&d){const[{deleteForwardEdits:o},{default:h}]=await Promise.all([w(()=>import("./deleteForwardEdits-BcYt-bvj.js"),__vite__mapDeps([0,1,2])),w(()=>import("./DeleteForwardEditsParameters-hdekXro9.js"),__vite__mapDeps([3,1,2]))]),u=await o(n,a,new h({sessionId:P,moment:t.moment}));return u.success&&t.stack?.clearForwardEdits(),u.success}return c}}return!0}function O(e,i){if(!e)return!1;const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=A.get(d)?.entries();if(n){for(const[r,a]of n)if(a.name===i)return a.lockType==="edit"}return!1}const M=new x.EventEmitter;function W(e){return M.on("apply-edits",new WeakRef(e))}function q(e){return M.on("update-moment",new WeakRef(e))}function Y(e,i,d=null,n=!1){const r=D();return n=i==null||n,M.emit("apply-edits",{serviceUrl:e,layerId:i,gdbVersion:d,mayReceiveServiceEdits:n,result:r.promise}),r}const H=Symbol();function z(e){return e!=null&&typeof e=="object"&&H in e}function p(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function I(e,i,d){const n=new URL(e).host,r=V.get(n),a=t=>!t||t===r;return a(i)&&a(d)||i===d}const C=e=>{var n;var i;let d=(n=class extends e{constructor(...r){super(...r),this[i]=!0,this._applyEditsHandler=a=>{const{serviceUrl:t,layerId:c,gdbVersion:o,mayReceiveServiceEdits:h,result:u}=a,b=t===this.url,f=c!=null&&this.layerId!=null&&c===this.layerId,S=p(this),$=p(this)&&I(t,o,this.gdbVersion);if(!b||S&&!$||!f&&!h)return;const L=u.then((s=>{if(this.lastEditsEventDate=new Date,f&&(s.addedFeatures.length||s.updatedFeatures.length||s.deletedFeatures.length||s.addedAttachments.length||s.updatedAttachments.length||s.deletedAttachments.length))return this.emit("edits",m(s)),s;const y=s.editedFeatures?.find((({layerId:F})=>F===this.layerId));if(y){const{adds:F,updates:v,deletes:_}=y.editedFeatures,E={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:F?F.map((({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]}))):[],deletedFeatures:_?_.map((({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]}))):[],updatedFeatures:v?v.map((({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]}))):[],editedFeatures:m(s.editedFeatures),exceededTransferLimit:!1,historicMoment:m(s.historicMoment)};return this.emit("edits",E),E}const g={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:m(s.editedFeatures),exceededTransferLimit:!1,historicMoment:m(s.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(t,o,g.historicMoment)&&this.emit("edits",g),g})).then((s=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(t,o,s.historicMoment)&&(this.historicMoment=s.historicMoment),s)));this.emit("apply-edits",{result:L})},this._updateMomentHandler=a=>{const{serviceUrl:t,gdbVersion:c,moment:o}=a,h=t===this.url,u=p(this),b=p(this)&&I(t,c,this.gdbVersion),f=p(this)&&!I(t,this.gdbVersion,null);h&&u&&b&&f&&"historicMoment"in this&&this.historicMoment!==o&&(this.historicMoment=o)},this.when().then((()=>{this.addHandles(W(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(q(this._updateMomentHandler))}),(()=>{}))}_shouldUpdateHistoricMoment(r,a,t){return"historicMoment"in this&&this.historicMoment!==t&&O(r,a)}},i=H,n);return j([T()],d.prototype,"lastEditsEventDate",void 0),d=j([k("esri.layers.mixins.EditBusLayer")],d),d};export{C as F,O as a,Y as c,N as i,G as o,z as p,P as t};
